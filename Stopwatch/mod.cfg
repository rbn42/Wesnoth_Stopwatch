[modification]
    id=stopwatch
    name=_"Stopwatch"
    description=_"Who is the slowest player?"
    require_modification=no
    [event]
        name=side turn
        first_time_only=no
        [lua]
            code = <<

function time()
    local t_secs = os.time()
    local t = os.date("*t", t_secs)
    local t_UTC = os.date("!*t", t_secs)
    t_UTC.isdst = t.isdst
    local UTC_secs = os.time(t_UTC) 
    return { value = t_secs + os.difftime(t_secs, UTC_secs) }
end

                        local result = wesnoth.synchronize_choice(time)
                        local vname = "Stopwatch_start" .. wesnoth.current.side
                        wesnoth.set_variable(vname, result.value)
                        >>
        [/lua]
    [/event]
    [event]
        name=side turn end
        first_time_only=no
        [lua]
            code = <<

function time()
    local t_secs = os.time()
    local t = os.date("*t", t_secs)
    local t_UTC = os.date("!*t", t_secs)
    t_UTC.isdst = t.isdst
    local UTC_secs = os.time(t_UTC) 
    return { value = t_secs + os.difftime(t_secs, UTC_secs) }
end

function fmt_time (t)
    if t > 100 then
        t = math.ceil( t / 60 ) .. "m" 
    else
        t = t .. "s"
    end
    return t
end

                        local result = wesnoth.synchronize_choice(time)
                        local time_end = result.value
                        local vname = "Stopwatch_start" .. wesnoth.current.side
                        local time_start = wesnoth.get_variable(vname)
                        local duration = time_end - time_start
                        vname = "Stopwatch_overall" .. wesnoth.current.side
                        local time_overall = wesnoth.get_variable(vname)
                        if time_overall == nil then time_overall = 0 end
                        time_overall = time_overall + duration
                        wesnoth.set_variable(vname, time_overall)
                        duration = fmt_time(duration)
                        time_overall = fmt_time(time_overall)

                        local name = wesnoth.sides[wesnoth.current.side].name
                        wesnoth.message(name, "finished turn in " .. duration .. " (" .. time_overall .. " overall).")
			>>
        [/lua]
    [/event]
[/modification]
